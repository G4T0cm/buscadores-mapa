<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planner Blueprint Colaborativo</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { margin: 0; overflow: hidden; background-color: #222; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
  #toolbar { position: fixed; top: 10px; left: 10px; z-index: 10; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 8px; display: flex; gap: 8px; }
  #toolbar button { background: #444; border: none; color: #fff; padding: 6px 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
  #toolbar button:hover { background: #666; }
  #canvasContainer { width: 100vw; height: 100vh; position: relative; overflow: hidden; cursor: grab; }
  #canvasContainer:active { cursor: grabbing; }
  #blueprint { position: absolute; top: 0; left: 0; transform-origin: 0 0; max-width: none; max-height: none; }
  #overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
  .item { position: absolute; cursor: move; border: 2px solid #181818; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; pointer-events:auto; transform-origin: 0 0; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.5); }
  .item textarea { width: 100%; height: 100%; background: transparent; color: #fff; border: none; resize: none; text-align: center; font-size: 14px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-weight: 600; overflow:hidden; }
</style>
</head>
<body>
<div id="toolbar">
  <button id="btnBase">Blueprint base</button>
  <button id="btnMapa">Mapa general</button>
</div>
<div id="canvasContainer">
  <img id="blueprint" src="https://i.ibb.co/YK2Cyyn/BAS2E.png" alt="Plano base">
  <div id="overlay"></div>
</div>
<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAfTy4JojRMP4flMhAgYCM8ST4KaqTyUVo",
  authDomain: "proyecto-7249b.firebaseapp.com",
  projectId: "proyecto-7249b",
  storageBucket: "proyecto-7249b.firebasestorage.app",
  messagingSenderId: "352567061253",
  appId: "1:352567061253:web:1eb365014d36462be0e56c",
  measurementId: "G-B4QJB2YVKG"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const BASE_URL = 'https://i.ibb.co/YK2Cyyn/BAS2E.png';
const MAPA_URL = 'https://i.ibb.co/1t0z4xkL/GTAV-ATLUS-8192x8192.png';
const img = document.getElementById('blueprint');
const container = document.getElementById('canvasContainer');
const overlay = document.getElementById('overlay');
let scale = 0.3, originX = 0, originY = 0, isPanning = false, startX = 0, startY = 0;
let currentLayer = 'BASE', selectedItemId = null;
let state = {};

// UID
function uid(){ return Math.random().toString(36).slice(2,9); }

// TRANSFORM
function updateTransform(){
  img.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
  renderItems();
}

// ZOOM & PAN
container.addEventListener('wheel', e=>{
  e.preventDefault();
  const rect = container.getBoundingClientRect();
  const offsetX = e.clientX - rect.left;
  const offsetY = e.clientY - rect.top;
  const delta = e.deltaY < 0 ? 1.1 : 0.9;
  originX -= (offsetX - originX) * (delta - 1);
  originY -= (offsetY - originY) * (delta - 1);
  scale *= delta;
  updateTransform();
});
container.addEventListener('mousedown', e=>{
  if(e.button===1||e.button===2){ isPanning=true; startX=e.clientX-originX; startY=e.clientY-originY; }
});
container.addEventListener('mousemove', e=>{
  if(isPanning){ originX=e.clientX-startX; originY=e.clientY-startY; updateTransform(); }
});
container.addEventListener('mouseup', ()=>{ isPanning=false; });
container.addEventListener('mouseleave', ()=>{ isPanning=false; });
container.addEventListener('contextmenu', e=>e.preventDefault());

// LAYERS
document.getElementById('btnBase').addEventListener('click', ()=>{currentLayer='BASE'; img.src=BASE_URL;});
document.getElementById('btnMapa').addEventListener('click', ()=>{currentLayer='MAPA'; img.src=MAPA_URL;});

// IMAGE LOAD
img.onload=()=>{
  img.width = img.naturalWidth;
  img.height = img.naturalHeight;
  updateTransform();
};

// RENDER ITEMS
function renderItems(){
  overlay.innerHTML='';
  Object.values(state).forEach(it=>{
    if(it.layer!==currentLayer) return;

    const el = document.createElement('div');
    el.className='item';
    el.style.left = (it.x*scale + originX)+'px';
    el.style.top = (it.y*scale + originY)+'px';
    el.style.width = (it.w*scale)+'px';
    el.style.height = (it.h*scale)+'px';

    // TEXTAREA
const ta = document.createElement('textarea');
ta.value = it.text;
ta.style.fontSize = (14*scale)+'px';
ta.style.fontFamily = 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif';
ta.style.fontWeight = '600';
ta.style.width='100%';
ta.style.height='100%';
ta.style.overflowY='auto';
ta.style.maxHeight='200px';
ta.style.resize='none';

// INPUT: actualizar tamaño y Firestore, sin renderItems()
ta.addEventListener('input', ()=>{
  it.text = ta.value;
  it.h = Math.min(ta.scrollHeight/scale, 200/scale);
  it.w = Math.max(100, ta.scrollWidth/scale);
  db.collection('items').doc(it.id).set(it); // sincroniza Firestore
  el.style.width = (it.w*scale)+'px';
  el.style.height = (it.h*scale)+'px';
});

// Shift+Enter para salto de línea
ta.addEventListener('keydown', e=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    db.collection('items').doc(it.id).set(it);
  }
});

    ta.addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault();
        db.collection('items').doc(it.id).set(it);
      }
    });
    el.appendChild(ta);

    // DELETE BUTTON
    const btnDelete = document.createElement('div');
    btnDelete.innerText='✕';
    btnDelete.style.position='absolute';
    btnDelete.style.top='2px';
    btnDelete.style.right='4px';
    btnDelete.style.cursor='pointer';
    btnDelete.style.color='#fff';
    btnDelete.style.fontWeight='bold';
    btnDelete.style.background='rgba(255,0,0,0.7)';
    btnDelete.style.borderRadius='50%';
    btnDelete.style.width='18px';
    btnDelete.style.height='18px';
    btnDelete.style.display='flex';
    btnDelete.style.alignItems='center';
    btnDelete.style.justifyContent='center';
    btnDelete.addEventListener('click', e=>{
      e.stopPropagation();
      db.collection('items').doc(it.id).delete();
      delete state[it.id];
      renderItems();
    });
    el.appendChild(btnDelete);

    // RESIZE HANDLE
    const handle = document.createElement('div');
    handle.style.position='absolute';
    handle.style.width='12px';
    handle.style.height='12px';
    handle.style.right='0';
    handle.style.bottom='0';
    handle.style.cursor='se-resize';
    handle.style.background='rgba(255,255,255,0.7)';
    handle.style.borderRadius='3px';
    el.appendChild(handle);

    handle.addEventListener('mousedown', e=>{
      e.stopPropagation();
      e.preventDefault();
      const startX = e.clientX;
      const startY = e.clientY;
      const startW = it.w;
      const startH = it.h;

      function onMouseMove(ev){
        it.w = Math.max(50, startW + (ev.clientX - startX)/scale);
        it.h = Math.max(50, startH + (ev.clientY - startY)/scale);
        db.collection('items').doc(it.id).set(it);
        el.style.width = (it.w*scale)+'px';
        el.style.height = (it.h*scale)+'px';
      }

      function onMouseUp(){
        window.removeEventListener('mousemove', onMouseMove);
        window.removeEventListener('mouseup', onMouseUp);
      }

      window.addEventListener('mousemove', onMouseMove);
      window.addEventListener('mouseup', onMouseUp);
    });

    // DRAG
    el.addEventListener('mousedown', e=>{
      if(e.button!==0 || e.target===handle) return; // no arrastrar si estás sobre el handle
      e.preventDefault();
      selectedItemId = it.id;
      let sx=e.clientX, sy=e.clientY;
      const ox=it.x, oy=it.y;
      function move(ev){
        it.x = ox + (ev.clientX-sx)/scale;
        it.y = oy + (ev.clientY-sy)/scale;
        db.collection('items').doc(it.id).set(it);
        el.style.left = (it.x*scale + originX)+'px';
        el.style.top = (it.y*scale + originY)+'px';
      }
      function up(){ window.removeEventListener('mousemove',move); window.removeEventListener('mouseup',up); }
      window.addEventListener('mousemove',move);
      window.addEventListener('mouseup',up);
    });

    overlay.appendChild(el);
  });
}
// CREATE NEW ITEM
container.addEventListener('click', e=>{
  if(e.target!==container) return;
  const rect = container.getBoundingClientRect();
  const x = (e.clientX - rect.left - originX)/scale;
  const y = (e.clientY - rect.top - originY)/scale;
  const text = prompt('Texto del cuadrado:', '');
  if(text!==null && text.trim()!==''){
    const id = uid();
    const item = {id, text, x, y, w:100, h:100, layer:currentLayer};
    state[id] = item;      // añadir al estado local para verlo inmediatamente
    renderItems();          // renderizar al instante
    db.collection('items').doc(id).set(item); // sincronizar con Firebase
  }
  
});
// DOBLE CLIC PARA CREAR ITEM CENTRADO
container.addEventListener('dblclick', e => {
  if(e.target.closest('.item')) return;

  const rect = container.getBoundingClientRect();
  const clickX = (e.clientX - rect.left - originX)/scale;
  const clickY = (e.clientY - rect.top - originY)/scale;

  const id = uid();
  const itemWidth = 100;
  const itemHeight = 100;

  // Centrar el item en el cursor
  const x = clickX - itemWidth / 2;
  const y = clickY - itemHeight / 2;

  const item = {id, text: '', x, y, w:itemWidth, h:itemHeight, layer:currentLayer};
  state[id] = item;

  renderItems(); // renderizamos el nuevo item

  db.collection('items').doc(id).set(item);

  // AUTO-FOCUS EN EL NUEVO TEXTAREA
  const el = overlay.querySelector(`.item:nth-last-child(1) textarea`);
  if(el) el.focus();
});


// DELETE KEY
window.addEventListener('keydown', e=>{
  if(e.key==='Delete' && selectedItemId){
    db.collection('items').doc(selectedItemId).delete();
    delete state[selectedItemId];
    selectedItemId=null;
    renderItems();
  }
});

// REAL-TIME FIRESTORE LISTENER
db.collection('items').onSnapshot(snapshot=>{
  snapshot.docChanges().forEach(change=>{
    const data = change.doc.data();
    if(change.type==='added' || change.type==='modified') state[data.id]=data;
    if(change.type==='removed') delete state[data.id];
  });
  renderItems();
});
</script>
</body>
</html>










